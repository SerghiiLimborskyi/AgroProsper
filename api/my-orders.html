<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“‹ ĞœĞ¾Ñ— Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <div id="landing-container">
    <h1>ğŸ“‹ ĞœĞ¾Ñ— Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ</h1>
    <label for="start">ğŸ“† Ğ’Ñ–Ğ´:</label>
<input type="date" id="start" />

<label for="end">ğŸ“† Ğ”Ğ¾:</label>
<input type="date" id="end" />

<button id="filter-btn">ğŸ” Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸</button>
<button id="clear-btn">ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸</button>

    
    <div id="orders">â³ Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
  </div>
<label for="region">ğŸ“ Ğ ĞµĞ³Ñ–Ğ¾Ğ½:</label>
<input type="text" id="region" placeholder="ĞĞ°Ğ¿Ñ€. ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ° Ğ¾Ğ±Ğ»." />

<label for="product">ğŸ“¦ Ğ¢Ğ¾Ğ²Ğ°Ñ€:</label>
<input type="text" id="product" placeholder="ĞĞ°Ğ¿Ñ€. Ğ¿ÑˆĞµĞ½Ğ¸Ñ†Ñ" />

<button id="filter-btn">ğŸ” Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸</button>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const ref = tg.initDataUnsafe?.user?.id || 'unknown';

    fetch(`https://your-domain.com/api/my-orders?ref=${ref}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('orders');
        if (!Array.isArray(data.orders) || data.orders.length === 0) {
          container.textContent = 'ğŸ˜” Ğ£ Ğ²Ğ°Ñ Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ” Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ.';
          return;
        }
function loadMyOrders(region = '', product = '') {
  const url = new URL('https://your-domain.com/api/my-orders');
  url.searchParams.append('ref', ref);
  if (region) url.searchParams.append('region', region);
  if (product) url.searchParams.append('product', product);

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('orders');
      if (!Array.isArray(data.orders) || data.orders.length === 0) {
        container.textContent = 'ğŸ˜” ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ Ğ·Ğ° Ñ†Ğ¸Ğ¼ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼.';
        return;
      }

      container.innerHTML = data.orders.map(o => `
        <div class="order-card">
          <h3>ğŸ“¦ ${o.product}</h3>
          <p>ğŸ“ ${o.region}</p>
          <p>ğŸ“ ${o.amount}</p>
          <p>ğŸ“ ${o.buyer_contact}</p>
          <p>ğŸ•’ ${new Date(o.timestamp).toLocaleString()}</p>
        </div>
      `).join('');
    })
    .catch(() => {
      document.getElementById('orders').textContent = 'âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ–.';
    });
}

document.getElementById('filter-btn').onclick = document.getElementById('clear-btn').onclick = () => {
  document.getElementById('region').value = '';
  document.getElementById('product').value = '';
  document.getElementById('start').value = '';
  document.getElementById('end').value = '';
  loadMyOrders(); // Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ±ĞµĞ· Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ñ–Ğ²
};
() => {
  const region = document.getElementById('region').value.trim();
  const product = document.getElementById('product').value.trim();
  loadMyOrders(region, product);
};

loadMyOrders(); // ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ

        
        container.innerHTML = data.orders.map(o => `
          <div class="order-card">
            <h3>ğŸ“¦ ${o.product}</h3>
            <p>ğŸ“ ${o.region}</p>
            <p>ğŸ“ ${o.amount}</p>
            <p>ğŸ“ ${o.buyer_contact}</p>
            <p>ğŸ•’ ${new Date(o.timestamp).toLocaleString()}</p>
          </div>
        `).join('');
      })
      .catch(() => {
        document.getElementById('orders').textContent = 'âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ–.';
      });
  </script>
</body>
</html>

app.get('/api/my-orders', async (req, res) => {
  const { ref, region, product } = req.query;
  if (!ref) return res.status(400).json({ error: 'Missing ref' });

  let formula = [`{ref_id} = '${ref}'`];
  if (region) formula.push(`{region} = '${region}'`);
  if (product) formula.push(`SEARCH(LOWER('${product}'), LOWER({product}))`);

  try {
    const records = await base('Orders').select({
      filterByFormula: `AND(${formula.join(',')})`,
      sort: [{ field: 'timestamp', direction: 'desc' }],
      maxRecords: 100
    }).all();

    const orders = records.map(r => ({
      product: r.fields.product,
      region: r.fields.region,
      amount: r.fields.amount,
      buyer_contact: r.fields.buyer_contact,
      timestamp: r.fields.timestamp
    }));

    res.json({ orders });
  } catch (err) {
    console.error('âŒ MyOrders error:', err);
    res.status(500).json({ error: 'Failed to fetch orders' });
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("badgeDashboard");
  if (!container) return;

  const achievements = JSON.parse(localStorage.getItem("achievements") || "[]");
  const level = localStorage.getItem("agentLevel") || "Starter";
  const cid = localStorage.getItem("cid") || "0xAGRO-GUEST";

  // ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
  const stats = document.createElement("div");
  stats.innerHTML = `
    <h2>ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</h2>
    <p>Ğ‘ĞµĞ¹Ğ´Ğ¶Ñ–Ğ²: ${achievements.length}</p>
    <p>Ğ Ñ–Ğ²ĞµĞ½ÑŒ: ${level}</p>
    <p>CID: ${cid}</p>
  `;
  container.appendChild(stats);

  // ğŸ”„ ĞšĞ½Ğ¾Ğ¿ĞºĞ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ°Ñ†Ñ–Ñ—
  const syncBtn = document.createElement("button");
  syncBtn.textContent = "ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸ (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾)";
  syncBtn.style = "margin:10px;padding:8px;background:#ccc;border:none;border-radius:6px;font-weight:bold;";
  syncBtn.onclick = () => syncBadgesLocally(achievements);
  container.appendChild(syncBtn);

  // ğŸ“¤ ĞšĞ½Ğ¾Ğ¿ĞºĞ° ĞµĞºÑĞ¿Ğ¾Ñ€Ñ‚Ñƒ
  const exportBtn = document.createElement("button");
  exportBtn.textContent = "ğŸ“¤ Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ CID-index.json";
  exportBtn.style = "margin:10px;padding:8px;background:#00ccff;border:none;border-radius:6px;font-weight:bold;";
  exportBtn.onclick = () => exportCIDIndex(achievements);
  container.appendChild(exportBtn);

  // ğŸ‘ï¸ Ğ“Ğ°Ğ»ĞµÑ€ĞµÑ Ğ±ĞµĞ¹Ğ´Ğ¶Ñ–Ğ²
  const gallery = document.createElement("section");
  gallery.className = "badge-grid";

  achievements.forEach(badge => {
    const card = document.createElement("div");
    card.className = "badge-card";

    const validCID = badge.cid && badge.cid.startsWith("baf");

    card.innerHTML = `
      <img src="${badge.img}" alt="${badge.title}" />
      <h3>${badge.title}</h3>
      <p>${badge.desc}</p>
      <p>ğŸ•’ ${badge.date || "â€”"}</p>
      <p>ğŸ¯ Ğ Ğ¾Ğ»ÑŒ: ${badge.role || "guest"}</p>
      <p>ğŸ“¡ Ğ”Ğ¶ĞµÑ€ĞµĞ»Ğ¾: ${badge.source || "DAO"}</p>
      <p>ğŸ§¬ CID: ${validCID ? badge.cid : "â€”"}</p>
      ${validCID ? `<small><a href="https://ipfs.io/ipfs/${badge.cid}" target="_blank">ğŸ”— IPFS</a></small>` : ""}
    `;
    gallery.appendChild(card);
  });

  container.appendChild(gallery);
});

// ğŸ”„ Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ°Ñ†Ñ–Ñ
function syncBadgesLocally(badges) {
  let updated = false;
  badges.forEach(badge => {
    if (!badge.cid) {
      badge.cid = "bafkre" + Math.random().toString(36).substring(2, 12);
      updated = true;
    }
  });
  if (updated) {
    localStorage.setItem("achievements", JSON.stringify(badges));
    alert("âœ… Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾");
    location.reload();
  } else {
    alert("â„¹ï¸ Ğ£ÑÑ– Ğ±ĞµĞ¹Ğ´Ğ¶Ñ– Ğ²Ğ¶Ğµ Ğ¼Ğ°ÑÑ‚ÑŒ CID");
  }
}

// ğŸ“¤ Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñƒ CID-index.json
function exportCIDIndex(badges) {
  const index = {};
  badges.forEach(badge => {
    if (badge.cid) index[badge.cid] = badge.title;
  });

  const blob = new Blob([JSON.stringify(index, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = "CID-index.json";
  link.click();

  URL.revokeObjectURL(url);
}

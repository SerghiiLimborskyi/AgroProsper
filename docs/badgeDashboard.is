document.addEventListener("DOMContentLoaded", () => {
  const lang = navigator.language.startsWith("pl") ? "pl" :
               navigator.language.startsWith("en") ? "en" : "uk";
  const t = {
    uk: { stats: "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", badges: "Ğ‘ĞµĞ¹Ğ´Ğ¶Ñ–Ğ²", level: "Ğ Ñ–Ğ²ĞµĞ½ÑŒ", cid: "CID", sync: "ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·ÑƒĞ²Ğ°Ñ‚Ğ¸", export: "ğŸ“¤ Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸", role: "Ğ Ğ¾Ğ»ÑŒ", source: "Ğ”Ğ¶ĞµÑ€ĞµĞ»Ğ¾", date: "Ğ”Ğ°Ñ‚Ğ°", view: "ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑƒÑ‚Ğ¸ Ğ½Ğ° IPFS" },
    pl: { stats: "ğŸ“Š Statystyki", badges: "Odznak", level: "Poziom", cid: "CID", sync: "ğŸ”„ Synchronizuj", export: "ğŸ“¤ Eksportuj", role: "Rola", source: "Å¹rÃ³dÅ‚o", date: "Data", view: "Zobacz na IPFS" },
    en: { stats: "ğŸ“Š Stats", badges: "Badges", level: "Level", cid: "CID", sync: "ğŸ”„ Sync", export: "ğŸ“¤ Export", role: "Role", source: "Source", date: "Date", view: "View on IPFS" }
  };
  const tr = t[lang];

  const container = document.getElementById("badgeDashboard");
  if (!container) return;

  const achievements = JSON.parse(localStorage.getItem("achievements") || "[]");
  const level = localStorage.getItem("agentLevel") || "Starter";
  const cid = localStorage.getItem("cid") || "0xAGRO-GUEST";

  // ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
  const stats = document.createElement("div");
  stats.innerHTML = `
    <h2>${tr.stats}</h2>
    <p>${tr.badges}: ${achievements.length}</p>
    <p>${tr.level}: ${level}</p>
    <p>${tr.cid}: ${cid}</p>
  `;
  container.appendChild(stats);

  // ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ°Ñ†Ñ–Ñ
  const syncBtn = document.createElement("button");
  syncBtn.textContent = tr.sync;
  syncBtn.style = "margin:10px;padding:8px;background:#ccc;border:none;border-radius:6px;font-weight:bold;";
  syncBtn.onclick = () => {
    let updated = false;
    achievements.forEach(badge => {
      if (!badge.cid) {
        badge.cid = "bafkre" + Math.random().toString(36).substring(2, 12);
        updated = true;
      }
    });
    if (updated) {
      localStorage.setItem("achievements", JSON.stringify(achievements));
      alert("âœ… Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾");
      location.reload();
    } else {
      alert("â„¹ï¸ CID Ğ²Ğ¶Ğµ Ğ¿Ñ€Ğ¸ÑĞ²Ğ¾Ñ”Ğ½Ğ¾");
    }
  };
  container.appendChild(syncBtn);

  // ğŸ“¤ Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚
  const exportBtn = document.createElement("button");
  exportBtn.textContent = tr.export + " CID-index.json";
  exportBtn.style = "margin:10px;padding:8px;background:#00ccff;border:none;border-radius:6px;font-weight:bold;";
  exportBtn.onclick = () => {
    const index = {};
    achievements.forEach(badge => {
      if (badge.cid) index[badge.cid] = badge.title;
    });
    const blob = new Blob([JSON.stringify(index, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "CID-index.json";
    link.click();
    URL.revokeObjectURL(url);
  };
  container.appendChild(exportBtn);

  // ğŸ‘ï¸ Ğ“Ğ°Ğ»ĞµÑ€ĞµÑ
  const gallery = document.createElement("section");
  gallery.className = "badge-grid";

  achievements.forEach(badge => {
    const validCID = badge.cid && badge.cid.startsWith("baf");
    const card = document.createElement("div");
    card.className = "badge-card";
    card.innerHTML = `
      <img src="${badge.img}" alt="${badge.title}" />
      <h3>${badge.title}</h3>
      <p>${badge.desc}</p>
      <p>ğŸ•’ ${tr.date}: ${badge.date || "â€”"}</p>
      <p>ğŸ¯ ${tr.role}: ${badge.role || "guest"}</p>
      <p>ğŸ“¡ ${tr.source}: ${badge.source || "DAO"}</p>
      <p>ğŸ§¬ ${tr.cid}: ${validCID ? badge.cid : "â€”"}</p>
      ${validCID ? `<small><a href="https://ipfs.io/ipfs/${badge.cid}" target="_blank">ğŸ”— ${tr.view}</a></small>` : ""}
    `;
    gallery.appendChild(card);
  });

  container.appendChild(gallery);
});

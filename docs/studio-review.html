<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé¨ DAO Studio Review</title>
  <script type="module" src="studio-api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #fefefe; }
    h1 { color: #00aa88; }
    table { width: 100%; margin-top: 2em; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    input, select { width: 100%; padding: 0.4em; }
    .btn { padding: 0.5em 1em; margin-top: 1em; cursor: pointer; }
    .publish { background: #4caf50; color: white; border: none; }
    .delete { background: #e53935; color: white; border: none; }
    .disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <h1>üé¨ DAO Studio ¬∑ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–µ–æ</h1>
  <div id="accessDenied" style="display:none; color:red;">‚ùå –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ DAO.</div>
  <table id="videoTable" style="display:none;">
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞</th><th>–ú–æ–≤–∞</th><th>–†–æ–ª—å</th><th>–¢–∏–ø</th><th>–ü–æ—Å–∏–ª–∞–Ω–Ω—è</th><th>üñäÔ∏è</th><th>üóëÔ∏è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="publishBtn" class="btn publish disabled">‚úÖ –ü—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏</button>

  <script type="module">
    import {
      getUserRole,
      fetchStudioIndex,
      updateStudioIndexSecure
    } from "./studio-api.js";

    const cid = localStorage.getItem("userCID") || "";
    if (!cid.includes("Admin")) {
      document.getElementById("accessDenied").style.display = "block";
      throw new Error("Access denied");
    }

    let videos = [];
    let sha = "";

    const table = document.querySelector("#videoTable");
    const tbody = table.querySelector("tbody");
    const publishBtn = document.getElementById("publishBtn");

    function renderTable() {
      tbody.innerHTML = "";
      videos.forEach((v, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input value="${v.title}" onchange="videos[${i}].title = this.value" /></td>
          <td>
            <select onchange="videos[${i}].lang = this.value">
              <option value="uk" ${v.lang === "uk" ? "selected" : ""}>üá∫üá¶</option>
              <option value="pl" ${v.lang === "pl" ? "selected" : ""}>üáµüá±</option>
              <option value="en" ${v.lang === "en" ? "selected" : ""}>üá¨üáß</option>
            </select>
          </td>
          <td>
            <select onchange="videos[${i}].role = this.value">
              <option value="any" ${v.role === "any" ? "selected" : ""}>–ë—É–¥—å-—è–∫–∞</option>
              <option value="guest" ${v.role === "guest" ? "selected" : ""}>–ì—ñ—Å—Ç—å</option>
              <option value="agent" ${v.role === "agent" ? "selected" : ""}>–ê–≥–µ–Ω—Ç</option>
              <option value="partner" ${v.role === "partner" ? "selected" : ""}>–ü–∞—Ä—Ç–Ω–µ—Ä</option>
            </select>
          </td>
          <td>
            <select onchange="videos[${i}].type = this.value">
              <option value="intro" ${v.type === "intro" ? "selected" : ""}>–ó–≤–µ—Ä–Ω–µ–Ω–Ω—è</option>
              <option value="quest" ${v.type === "quest" ? "selected" : ""}>–ö–≤–µ—Å—Ç</option>
              <option value="promo" ${v.type === "promo" ? "selected" : ""}>–ü—Ä–æ–º–æ</option>
              <option value="dashboard" ${v.type === "dashboard" ? "selected" : ""}>–ü–∞–Ω–µ–ª—å</option>
            </select>
          </td>
          <td><input value="${v.url}" onchange="videos[${i}].url = this.value" /></td>
          <td><button class="btn delete" onclick="deleteVideo(${i})">‚úñ</button></td>
        `;
        tbody.appendChild(row);
      });
      table.style.display = "table";
      publishBtn.classList.remove("disabled");
    }

    window.deleteVideo = function(index) {
      videos.splice(index, 1);
      renderTable();
    };

    publishBtn.onclick = async () => {
      publishBtn.textContent = "‚è≥ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è...";
      publishBtn.classList.add("disabled");
      try {
        await updateStudioIndexSecure({ videos });
        alert("‚úÖ –ó–º—ñ–Ω–∏ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ");
      } catch (err) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó");
      }
      publishBtn.textContent = "‚úÖ –ü—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏";
      publishBtn.classList.remove("disabled");
    };

    const { json, sha: currentSha } = await fetchStudioIndex();
    videos = json.videos;
    sha = currentSha;
    renderTable();
  </script>
</body>
</html>

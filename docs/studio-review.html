<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¬ DAO Studio Review</title>
  <script type="module" src="studio-api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #fefefe; }
    h1 { color: #00aa88; }
    table { width: 100%; margin-top: 2em; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    input, select { width: 100%; padding: 0.4em; }
    .btn { padding: 0.5em 1em; margin-top: 1em; cursor: pointer; }
    .publish { background: #4caf50; color: white; border: none; }
    .delete { background: #e53935; color: white; border: none; }
    .disabled { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <h1>ğŸ¬ DAO Studio Â· ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ²Ñ–Ğ´ĞµĞ¾</h1>
  <div id="accessDenied" style="display:none; color:red;">âŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ±Ğ¾Ñ€Ğ¾Ğ½ĞµĞ½Ğ¾. Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ñ–Ğ½Ñ–ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° DAO.</div>
  <table id="videoTable" style="display:none;">
    <thead>
      <tr>
        <th>ĞĞ°Ğ·Ğ²Ğ°</th><th>ĞœĞ¾Ğ²Ğ°</th><th>Ğ Ğ¾Ğ»ÑŒ</th><th>Ğ¢Ğ¸Ğ¿</th><th>ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ</th><th>ğŸ–Šï¸</th><th>ğŸ—‘ï¸</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <button id="publishBtn" class="btn publish disabled">âœ… ĞŸÑƒĞ±Ğ»Ñ–ĞºÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸</button>
<button id="viewLogBtn" class="btn">ğŸ§¾ ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑƒÑ‚Ğ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ</button>
<div id="logViewer" style="margin-top:2em;"></div>
  <button id="exportLogBtn" class="btn">ğŸ“¤ Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»</button>
  
  <script type="module">
    import {
      getUserRole,
      fetchStudioIndex,
      updateStudioIndexSecure
    } from "./studio-api.js";

    const cid = localStorage.getItem("userCID") || "";
    if (!cid.includes("Admin")) {
      document.getElementById("accessDenied").style.display = "block";
      throw new Error("Access denied");
    }

    let videos = [];
    let sha = "";

    const table = document.querySelector("#videoTable");
    const tbody = table.querySelector("tbody");
    const publishBtn = document.getElementById("publishBtn");
    
document.getElementById("viewLogBtn").onclick = async () => {
  const res = await fetch("studio-log.json");
  const data = await res.json();
  const logDiv = document.getElementById("logViewer");
  logDiv.innerHTML = "<h3>ğŸ“œ Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ·Ğ¼Ñ–Ğ½</h3>";
  data.log.forEach(entry => {
    const block = document.createElement("div");
    block.style.borderLeft = "4px solid #ccc";
    block.style.padding = "1em";
    block.style.marginBottom = "1em";
    block.innerHTML = `
      <strong>${entry.timestamp}</strong><br/>
      ğŸ‘¤ ${entry.editor}<br/>
      ğŸ› ï¸ ${entry.action}<br/>
      ğŸï¸ <em>${entry.video.title}</em> (${entry.video.lang}, ${entry.video.role}, ${entry.video.type})<br/>
      ğŸ”— <a href="${entry.video.url}" target="_blank">ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑƒÑ‚Ğ¸ Ğ²Ñ–Ğ´ĞµĞ¾</a>
    `;
    logDiv.appendChild(block);
  });
};
    
    document.getElementById("exportLogBtn").onclick = async () => {
  const res = await fetch("studio-log.json");
  const data = await res.json();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "studio-log.json";
  a.click();
  URL.revokeObjectURL(url);
};

    import { generateSignature } from "./studio-sign.js";

const logEntry = {
  timestamp: new Date().toISOString(),
  editor: "Admin:" + localStorage.getItem("userCID"),
  action: "ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ²Ñ–Ğ´ĞµĞ¾",
  video: newVideo
};

logEntry.signature = await generateSignature(logEntry);
// Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ´Ğ¾ studio-log.json
    import { verifySignature } from "./studio-sign.js";

const valid = await verifySignature(entry);
if (!valid) block.style.borderLeft = "4px solid red"; // âŒ ĞŸÑ–Ğ´Ğ¿Ğ¸Ñ Ğ½ĞµĞ´Ñ–Ğ¹ÑĞ½Ğ¸Ğ¹

    import { verifySignature } from "./studio-sign.js";

data.log.forEach(async entry => {
  const block = document.createElement("div");
  const valid = await verifySignature(entry);
  block.style.borderLeft = valid ? "4px solid #ccc" : "4px solid red";
  block.style.padding = "1em";
  block.style.marginBottom = "1em";
  block.innerHTML = `
    <strong>${entry.timestamp}</strong><br/>
    ğŸ‘¤ ${entry.editor}<br/>
    ğŸ› ï¸ ${entry.action}<br/>
    ğŸï¸ <em>${entry.video.title}</em> (${entry.video.lang}, ${entry.video.role}, ${entry.video.type})<br/>
    ğŸ”— <a href="${entry.video.url}" target="_blank">ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑƒÑ‚Ğ¸ Ğ²Ñ–Ğ´ĞµĞ¾</a><br/>
    ${valid ? "" : "<span style='color:red;'>âŒ ĞŸÑ–Ğ´Ğ¿Ğ¸Ñ Ğ½ĞµĞ´Ñ–Ğ¹ÑĞ½Ğ¸Ğ¹</span>"}
  `;
  logDiv.appendChild(block);
});
    
    function renderTable() {
      tbody.innerHTML = "";
      videos.forEach((v, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input value="${v.title}" onchange="videos[${i}].title = this.value" /></td>
          <td>
            <select onchange="videos[${i}].lang = this.value">
              <option value="uk" ${v.lang === "uk" ? "selected" : ""}>ğŸ‡ºğŸ‡¦</option>
              <option value="pl" ${v.lang === "pl" ? "selected" : ""}>ğŸ‡µğŸ‡±</option>
              <option value="en" ${v.lang === "en" ? "selected" : ""}>ğŸ‡¬ğŸ‡§</option>
            </select>
          </td>
          <td>
            <select onchange="videos[${i}].role = this.value">
              <option value="any" ${v.role === "any" ? "selected" : ""}>Ğ‘ÑƒĞ´ÑŒ-ÑĞºĞ°</option>
              <option value="guest" ${v.role === "guest" ? "selected" : ""}>Ğ“Ñ–ÑÑ‚ÑŒ</option>
              <option value="agent" ${v.role === "agent" ? "selected" : ""}>ĞĞ³ĞµĞ½Ñ‚</option>
              <option value="partner" ${v.role === "partner" ? "selected" : ""}>ĞŸĞ°Ñ€Ñ‚Ğ½ĞµÑ€</option>
            </select>
          </td>
          <td>
            <select onchange="videos[${i}].type = this.value">
              <option value="intro" ${v.type === "intro" ? "selected" : ""}>Ğ—Ğ²ĞµÑ€Ğ½ĞµĞ½Ğ½Ñ</option>
              <option value="quest" ${v.type === "quest" ? "selected" : ""}>ĞšĞ²ĞµÑÑ‚</option>
              <option value="promo" ${v.type === "promo" ? "selected" : ""}>ĞŸÑ€Ğ¾Ğ¼Ğ¾</option>
              <option value="dashboard" ${v.type === "dashboard" ? "selected" : ""}>ĞŸĞ°Ğ½ĞµĞ»ÑŒ</option>
            </select>
          </td>
          <td><input value="${v.url}" onchange="videos[${i}].url = this.value" /></td>
          <td><button class="btn delete" onclick="deleteVideo(${i})">âœ–</button></td>
        `;
        tbody.appendChild(row);
      });
      table.style.display = "table";
      publishBtn.classList.remove("disabled");
    }

    window.deleteVideo = function(index) {
      videos.splice(index, 1);
      renderTable();
    };

    publishBtn.onclick = async () => {
      publishBtn.textContent = "â³ ĞŸÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ†Ñ–Ñ...";
      publishBtn.classList.add("disabled");
      try {
        await updateStudioIndexSecure({ videos });
        alert("âœ… Ğ—Ğ¼Ñ–Ğ½Ğ¸ Ğ¾Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾");
      } catch (err) {
        alert("âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ†Ñ–Ñ—");
      }
      publishBtn.textContent = "âœ… ĞŸÑƒĞ±Ğ»Ñ–ĞºÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸";
      publishBtn.classList.remove("disabled");
    };

    const { json, sha: currentSha } = await fetchStudioIndex();
    videos = json.videos;
    sha = currentSha;
    renderTable();
  </script>
</body>
</html>
